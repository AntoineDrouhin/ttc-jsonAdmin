/**
 * Admin json action registering
 * @version v0.1.0-dev-2016-12-11
 * @link 
 */
"use strict";angular.module("ttcJsonAdminModule",["ngMaterial","ui.ace"]).directive("ttcJsonAdmin",["$log","$http","$mdDialog",function(a,b,c){return{restrict:"E",templateUrl:"./jsonAdminView.html",scope:{routeApiActions:"=routeApiActions"},link:function(d){d.actions={},d.actions.data=[],d.selectedAction={},b({method:"GET",url:d.routeApiActions.api_route}).then(function(a){for(var b=0;b<a.data.length;b++){var c=a.data[b];d.actions.data.push({name:c.name,originJson:c.json,currentJson:c.json,id:c.id})}},function(b){a.info("Get actions : Unable to reach server")}),d.convertToAce=function(a){var b="",c="",d=[],e=JSON.stringify(a);return angular.forEach(e,function(a){"{"==a?(d.push("\t"),b+=a+"\n"+d.join("")):","!=a||'"'!=c&&"e"!=c&&"d"!=c?"}"==a?(d.splice(0,1),b+="\n"+d.join("")+a):b+=a:b+=a+"\n"+d.join(""),c=a}),b},d.$watch("loadAce",function(a){d.aceOption={mode:"json",require:["ace/ext/language_tools"],theme:"chrome",onLoad:function(a){var b=a.getSession();b.on("changeAnnotation",function(){var b=a.getSession().getAnnotations();b.length?d.editorError=b[0]:d.editorError=!1,d.selectedAction&&(d.selectedAction.currentJson=a.getValue())})}},d.aceAvailable=!0}),d.$watch("height",function(a){d.currentHeight=a-20||800,d.maxHeightContainer=a-45}),d.jsonActionModels={image:{type:"image",cmd:"string",url:"string"},service:{type:"service",cmd:"string",url:"string",method:"string"}},d.showHelp=function(){c.show(c.alert().clickOutsideToClose(!0).title("Aide des modèles").textContent(d.convertToAce(d.jsonActionModels)).ariaLabel("JSON").ok("OK"))},d.isValidateImageAction=function(a){var b=d.jsonActionModels.image;return a.type==b.type&&(typeof a.cmd==typeof b.cmd&&typeof a.url==typeof b.url)},d.isValidateServiceAction=function(a){var b=d.jsonActionModels.service;return a.type==b.type&&(typeof a.cmd==typeof b.cmd&&(typeof a.url==typeof b.url&&(!!a.method&&typeof a.method==typeof b.method)))},d.isValidateJson=function(a){if("string"==typeof a)try{a=angular.fromJson(a)}catch(a){return!1}if(!a.type)return!1;if("string"!=typeof a.type)return!1;if(!a.cmd)return!1;if(!a.url)return!1;switch(a.type){case"image":return d.isValidateImageAction(a);case"service":return d.isValidateServiceAction(a);default:return!1}},d.selectAction=function(a){d.selectedAction=a,d.aceAvailable=!1,d.actions.idActionSelected=a.id,a?d.aceModel=a.currentJson:d.aceModel="{\n\t\n}",d.loadAce=moment().valueOf()},d.newAction=function(){var e={name:"",originJson:"{}",currentJson:"{}"},f=c.prompt().title("Name your action").textContent("Insert your action's name").placeholder("My Action").ariaLabel("action").ok("Okay!").cancel("Cancel");c.show(f).then(function(c){e.name=c,b({method:"POST",url:d.routeApiActions.api_route,data:{name:e.name,json:e.currentJson}}).then(function(a){e.id=a.data,d.actions.data.push(e),d.selectAction(e)},function(b){a.error(b)})},function(){e=!1})},d.clearActionLocalChange=function(){d.selectedAction.currentJson&&d.selectedAction.originJson&&(d.selectedAction.currentJson=d.selectedAction.originJson),d.selectAction(d.selectedAction)},d.saveAction=function(){return d.isValidateJson(d.selectedAction.currentJson)?void b({method:"PUT",url:d.routeApiActions.api_route+d.selectedAction.id,data:{name:d.selectedAction.name,json:d.selectedAction.currentJson}}).then(function(b){a.debug(b)},function(b){a.error(b)}):(c.show(c.alert().clickOutsideToClose(!0).title("JSON Incompatible").textContent("Votre JSON ne correspond pas aux modèles possibles ou un érreur de syntaxe empèche sa sauvegarde.").ariaLabel("Compatibilité JSON").ok("OK")),!1)},d.deleteAction=function(){b({method:"DELETE",url:d.routeApiActions.api_route+d.selectedAction.id}).then(function(b){for(var c=0;c<d.actions.data.length;c++){var e=d.actions.data[c];if(e.id=d.selectedAction.id){d.actions.data.splice(c,1),d.aceModel="";break}}a.debug(b)},function(b){a.error(b)})},d.confirmAndDeleteAction=function(b){var e=c.confirm().title("Souhaitez vous vraiment supprimer cette commande ?").textContent("").ariaLabel("Suppréssion de commande").targetEvent(b).ok("Oui").cancel("Non");c.show(e).then(function(){d.deleteAction(d.selectedAction.id)},function(){a.info("action not deleted")})}}}}]);